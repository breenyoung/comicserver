{% extends "base.html" %}

{% block title %}Series - Comic Server{% endblock %}

{% block content %}
<div class="space-y-6" x-data="seriesDetail()" x-init="loadSeries()">
    <!-- Back button -->
    <div class="flex items-center space-x-4">
        <a href="/" class="text-blue-400 hover:text-blue-300">
            ‚Üê Back to Library
        </a>
    </div>
    
    <!-- Loading state -->
    <div x-show="loading" class="flex items-center justify-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
    </div>
    
    <!-- Series details -->
    <div x-show="!loading && series" style="display: none;">
        <!-- Header with cover and info -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <div class="flex items-start space-x-6">
                <!-- Cover thumbnail -->
                <div class="flex-shrink-0">
                    <div x-show="firstIssue" class="w-48 h-72 bg-gray-700 rounded-lg overflow-hidden">
                        <img 
                            :src="firstIssue ? `/api/comics/${firstIssue.id}/thumbnail?width=300&height=450` : ''"
                            :alt="series?.name"
                            class="w-full h-full object-cover"
                        >
                    </div>
                    <div x-show="!firstIssue" class="w-48 h-72 bg-gray-700 rounded-lg flex items-center justify-center text-gray-500">
                        No Cover
                    </div>
                </div>
                
                <!-- Series info -->
                <div class="flex-1">
                    <h1 class="text-4xl font-bold mb-2" x-text="series?.name"></h1>
                    <div class="space-y-2 text-lg">
                        <p class="text-gray-400">
                            <span class="text-gray-500">Publisher:</span> 
                            <span x-text="series?.publisher || 'Unknown'"></span>
                        </p>
                        <p class="text-gray-400">
                            <span class="text-gray-500">Started:</span> 
                            <span x-text="series?.start_year || 'Unknown'"></span>
                        </p>
                        <div class="flex items-center space-x-4 text-sm text-gray-500 mt-4">
                            <span x-text="`${series?.volume_count || 0} volume${series?.volume_count !== 1 ? 's' : ''}`"></span>
                            <span>‚Ä¢</span>
                            <span x-text="`${series?.total_issues || 0} issue${series?.total_issues !== 1 ? 's' : ''}`"></span>
                            <span x-show="series?.annual_count > 0">‚Ä¢</span>
                            <span x-show="series?.annual_count > 0" x-text="`${series?.annual_count} annual${series?.annual_count !== 1 ? 's' : ''}`"></span>
                            <span x-show="series?.special_count > 0">‚Ä¢</span>
                            <span x-show="series?.special_count > 0" x-text="`${series?.special_count} special${series?.special_count !== 1 ? 's' : ''}`"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tabbed interface -->
        <div class="bg-gray-800 rounded-lg overflow-hidden">
            <!-- Tab headers -->
            <div class="flex border-b border-gray-700 overflow-x-auto">
                <button 
                    @click="activeTab = 'volumes'"
                    :class="activeTab === 'volumes' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'"
                    class="px-6 py-4 font-medium whitespace-nowrap transition-colors"
                >
                    Volumes
                </button>
                <button 
                    @click="activeTab = 'issues'"
                    :class="activeTab === 'issues' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'"
                    class="px-6 py-4 font-medium whitespace-nowrap transition-colors"
                >
                    All Issues
                </button>
                <button 
                    @click="activeTab = 'annuals'"
                    :class="activeTab === 'annuals' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'"
                    class="px-6 py-4 font-medium whitespace-nowrap transition-colors"
                    x-show="series?.annual_count > 0"
                >
                    Annuals <span class="text-xs ml-1" x-text="`(${series?.annual_count})`"></span>
                </button>
                <button 
                    @click="activeTab = 'specials'"
                    :class="activeTab === 'specials' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'"
                    class="px-6 py-4 font-medium whitespace-nowrap transition-colors"
                    x-show="series?.special_count > 0"
                >
                    Specials <span class="text-xs ml-1" x-text="`(${series?.special_count})`"></span>
                </button>
                <button 
                    @click="activeTab = 'related'"
                    :class="activeTab === 'related' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'"
                    class="px-6 py-4 font-medium whitespace-nowrap transition-colors"
                >
                    Related
                </button>
                <button 
                    @click="activeTab = 'details'"
                    :class="activeTab === 'details' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'"
                    class="px-6 py-4 font-medium whitespace-nowrap transition-colors"
                >
                    Details
                </button>
            </div>
            
            <!-- Tab content -->
            <div class="p-6">
                <!-- Volumes Tab -->
                <div x-show="activeTab === 'volumes'" style="display: none;">
                    <template x-if="volumes && volumes.length > 0">
                        <div class="space-y-6">
                            <template x-for="volume in volumes" :key="volume.volume_number">
                                <div class="bg-gray-700 rounded-lg p-4">
                                    <h3 class="text-xl font-bold mb-3">
                                        Volume <span x-text="volume.volume_number"></span>
                                        <span class="text-sm text-gray-400 ml-2" x-text="`(${volume.issues.length} issue${volume.issues.length !== 1 ? 's' : ''})`"></span>
                                    </h3>
                                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                        <template x-for="issue in volume.issues" :key="issue.id">
                                            <a :href="`/reader/${issue.id}`" class="comic-card">
                                                <div class="aspect-[2/3] bg-gray-800 rounded-lg overflow-hidden relative group">
                                                    <img 
                                                        :src="`/api/comics/${issue.id}/thumbnail`"
                                                        :alt="`#${issue.number}`"
                                                        class="w-full h-full object-cover"
                                                        loading="lazy"
                                                    >
                                                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-70 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100">
                                                        <span class="text-white font-bold">Read</span>
                                                    </div>
                                                </div>
                                                <div class="mt-2">
                                                    <p class="font-medium truncate" x-text="`#${issue.number}`"></p>
                                                    <p class="text-sm text-gray-400 truncate" x-text="issue.title || ''"></p>
                                                    <p class="text-xs text-gray-500" x-text="issue.year || ''"></p>
                                                </div>
                                            </a>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                    <div x-show="!volumes || volumes.length === 0" class="text-center py-12 text-gray-400">
                        <p>No volumes found</p>
                    </div>
                </div>
                
                <!-- All Issues Tab -->
                <div x-show="activeTab === 'issues'" style="display: none;">
                    <template x-if="allIssues && allIssues.length > 0">
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            <template x-for="issue in allIssues" :key="issue.id">
                                <a :href="`/reader/${issue.id}`" class="comic-card">
                                    <div class="aspect-[2/3] bg-gray-800 rounded-lg overflow-hidden relative group">
                                        <img 
                                            :src="`/api/comics/${issue.id}/thumbnail`"
                                            :alt="`V${issue.volume_number} #${issue.number}`"
                                            class="w-full h-full object-cover"
                                            loading="lazy"
                                        >
                                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-70 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100">
                                            <span class="text-white font-bold">Read</span>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <p class="font-medium truncate" x-text="`Vol ${issue.volume_number} #${issue.number}`"></p>
                                        <p class="text-sm text-gray-400 truncate" x-text="issue.title || ''"></p>
                                        <p class="text-xs text-gray-500" x-text="issue.year || ''"></p>
                                    </div>
                                </a>
                            </template>
                        </div>
                    </template>
                    <div x-show="!allIssues || allIssues.length === 0" class="text-center py-12 text-gray-400">
                        <p>No issues found</p>
                    </div>
                </div>
                
                <!-- Annuals Tab -->
                <div x-show="activeTab === 'annuals'" style="display: none;">
                    <template x-if="annuals && annuals.length > 0">
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            <template x-for="issue in annuals" :key="issue.id">
                                <a :href="`/reader/${issue.id}`" class="comic-card">
                                    <div class="aspect-[2/3] bg-gray-800 rounded-lg overflow-hidden relative group">
                                        <img 
                                            :src="`/api/comics/${issue.id}/thumbnail`"
                                            :alt="`Annual #${issue.number}`"
                                            class="w-full h-full object-cover"
                                            loading="lazy"
                                        >
                                        <div class="absolute top-2 right-2 bg-yellow-600 text-white text-xs px-2 py-1 rounded">
                                            Annual
                                        </div>
                                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-70 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100">
                                            <span class="text-white font-bold">Read</span>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <p class="font-medium truncate" x-text="`Vol ${issue.volume_number} #${issue.number}`"></p>
                                        <p class="text-sm text-gray-400 truncate" x-text="issue.title || ''"></p>
                                        <p class="text-xs text-gray-500" x-text="issue.year || ''"></p>
                                    </div>
                                </a>
                            </template>
                        </div>
                    </template>
                    <div x-show="!annuals || annuals.length === 0" class="text-center py-12 text-gray-400">
                        <p>No annuals found</p>
                    </div>
                </div>
                
                <!-- Specials Tab -->
                <div x-show="activeTab === 'specials'" style="display: none;">
                    <template x-if="specials && specials.length > 0">
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            <template x-for="issue in specials" :key="issue.id">
                                <a :href="`/reader/${issue.id}`" class="comic-card">
                                    <div class="aspect-[2/3] bg-gray-800 rounded-lg overflow-hidden relative group">
                                        <img 
                                            :src="`/api/comics/${issue.id}/thumbnail`"
                                            :alt="`Special #${issue.number}`"
                                            class="w-full h-full object-cover"
                                            loading="lazy"
                                        >
                                        <div class="absolute top-2 right-2 bg-purple-600 text-white text-xs px-2 py-1 rounded" x-text="issue.format">
                                        </div>
                                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-70 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100">
                                            <span class="text-white font-bold">Read</span>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <p class="font-medium truncate" x-text="`Vol ${issue.volume_number} #${issue.number}`"></p>
                                        <p class="text-sm text-gray-400 truncate" x-text="issue.title || ''"></p>
                                        <p class="text-xs text-gray-500" x-text="issue.year || ''"></p>
                                    </div>
                                </a>
                            </template>
                        </div>
                    </template>
                    <div x-show="!specials || specials.length === 0" class="text-center py-12 text-gray-400">
                        <p>No specials found</p>
                    </div>
                </div>
                
                <!-- Related Tab -->
                <div x-show="activeTab === 'related'" style="display: none;">
                    <div class="space-y-6">
                        <!-- Collections -->
                        <div x-show="relatedCollections && relatedCollections.length > 0">
                            <h3 class="text-xl font-bold mb-4">Collections</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <template x-for="collection in relatedCollections" :key="collection.id">
                                    <a :href="`/collections/${collection.id}`" class="block bg-gray-700 rounded-lg p-4 hover:bg-gray-650 transition-colors">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <h4 class="font-bold" x-text="collection.name"></h4>
                                                <p class="text-sm text-gray-400 mt-1" x-text="collection.description || ''"></p>
                                                <p class="text-xs text-gray-500 mt-2" x-text="`${collection.comic_count} comics`"></p>
                                            </div>
                                            <div class="text-2xl ml-4">üìö</div>
                                        </div>
                                    </a>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Reading Lists -->
                        <div x-show="relatedReadingLists && relatedReadingLists.length > 0">
                            <h3 class="text-xl font-bold mb-4">Reading Lists</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <template x-for="list in relatedReadingLists" :key="list.id">
                                    <a :href="`/reading-lists/${list.id}`" class="block bg-gray-700 rounded-lg p-4 hover:bg-gray-650 transition-colors">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <h4 class="font-bold" x-text="list.name"></h4>
                                                <p class="text-sm text-gray-400 mt-1" x-text="list.description || ''"></p>
                                                <p class="text-xs text-gray-500 mt-2" x-text="`${list.comic_count} comics`"></p>
                                            </div>
                                            <div class="text-2xl ml-4">üìñ</div>
                                        </div>
                                    </a>
                                </template>
                            </div>
                        </div>
                        
                        <div x-show="(!relatedCollections || relatedCollections.length === 0) && (!relatedReadingLists || relatedReadingLists.length === 0)" class="text-center py-12 text-gray-400">
                            <p>No related collections or reading lists</p>
                        </div>
                    </div>
                </div>
                
                <!-- Details Tab -->
                <div x-show="activeTab === 'details'" style="display: none;">
                    <div class="space-y-6">
                        <!-- Folder Path -->
                        <div x-show="series?.folder_path">
                            <h3 class="text-lg font-bold mb-2">Folder Path</h3>
                            <p class="text-gray-400 font-mono text-sm bg-gray-900 p-3 rounded" x-text="series?.folder_path"></p>
                        </div>
                        
                        <!-- Writers -->
                        <div x-show="details?.writers && details.writers.length > 0">
                            <h3 class="text-lg font-bold mb-2">Writers</h3>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="writer in details?.writers" :key="writer">
                                    <span class="bg-gray-700 px-3 py-1 rounded-full text-sm" x-text="writer"></span>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Pencillers -->
                        <div x-show="details?.pencillers && details.pencillers.length > 0">
                            <h3 class="text-lg font-bold mb-2">Pencillers</h3>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="penciller in details?.pencillers" :key="penciller">
                                    <span class="bg-gray-700 px-3 py-1 rounded-full text-sm" x-text="penciller"></span>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Characters -->
                        <div x-show="details?.characters && details.characters.length > 0">
                            <h3 class="text-lg font-bold mb-2">Characters</h3>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="character in details?.characters" :key="character">
                                    <span class="bg-blue-900 bg-opacity-50 px-3 py-1 rounded-full text-sm" x-text="character"></span>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Teams -->
                        <div x-show="details?.teams && details.teams.length > 0">
                            <h3 class="text-lg font-bold mb-2">Teams</h3>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="team in details?.teams" :key="team">
                                    <span class="bg-green-900 bg-opacity-50 px-3 py-1 rounded-full text-sm" x-text="team"></span>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Locations -->
                        <div x-show="details?.locations && details.locations.length > 0">
                            <h3 class="text-lg font-bold mb-2">Locations</h3>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="location in details?.locations" :key="location">
                                    <span class="bg-purple-900 bg-opacity-50 px-3 py-1 rounded-full text-sm" x-text="location"></span>
                                </template>
                            </div>
                        </div>
                        
                        <div x-show="!details || (!details.writers?.length && !details.pencillers?.length && !details.characters?.length && !details.teams?.length && !details.locations?.length)" class="text-center py-12 text-gray-400">
                            <p>No additional details available</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Error state -->
    <div x-show="!loading && error" style="display: none;" class="text-center py-12 text-red-400">
        <p class="text-lg" x-text="error"></p>
        <a href="/" class="btn-secondary mt-4">Back to Library</a>
    </div>
</div>

<script>
function seriesDetail() {
    return {
        series: null,
        volumes: [],
        allIssues: [],
        annuals: [],
        specials: [],
        relatedCollections: [],
        relatedReadingLists: [],
        details: null,
        firstIssue: null,
        loading: true,
        error: null,
        activeTab: 'volumes',
        seriesId: {{ series_id }},
        
        async loadSeries() {
            try {
                const response = await fetch(`/api/series/${this.seriesId}`);
                if (!response.ok) {
                    throw new Error('Series not found');
                }
                
                const data = await response.json();
                this.series = data;
                
                // Process volumes and issues
                this.processIssues(data.issues);
                
                // Get related collections and reading lists
                this.relatedCollections = data.collections || [];
                this.relatedReadingLists = data.reading_lists || [];
                
                // Get aggregated details
                this.details = data.details || {};
                
                // Get first issue for cover
                if (this.allIssues.length > 0) {
                    this.firstIssue = this.allIssues[0];
                }
                
                this.loading = false;
                
                // Update page title
                document.title = `${data.name} - Comic Server`;
            } catch (err) {
                console.error('Error loading series:', err);
                this.error = 'Failed to load series. Please try again.';
                this.loading = false;
            }
        },
        
        processIssues(issues) {
            if (!issues || issues.length === 0) return;
            
            // Sort all issues by volume then issue number
            const sorted = [...issues].sort((a, b) => {
                if (a.volume_number !== b.volume_number) {
                    return a.volume_number - b.volume_number;
                }
                return parseFloat(a.number) - parseFloat(b.number);
            });
            
            this.allIssues = sorted;
            
            // Group by volume
            const volumeMap = {};
            sorted.forEach(issue => {
                if (!volumeMap[issue.volume_number]) {
                    volumeMap[issue.volume_number] = {
                        volume_number: issue.volume_number,
                        issues: []
                    };
                }
                volumeMap[issue.volume_number].issues.push(issue);
            });
            
            this.volumes = Object.values(volumeMap).sort((a, b) => a.volume_number - b.volume_number);
            
            // Filter annuals (format === 'Annual')
            this.annuals = sorted.filter(issue => 
                issue.format && issue.format.toLowerCase() === 'annual'
            );
            
            // Filter specials (format set but not 'Annual')
            this.specials = sorted.filter(issue => 
                issue.format && issue.format.toLowerCase() !== 'annual'
            );
        }
    }
}
</script>

<style>
.hover\:bg-gray-650:hover {
    background-color: #3d4756;
}
</style>
{% endblock %}
